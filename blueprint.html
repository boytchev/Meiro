<!DOCTYPE html>

<html>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<head>
		<link rel="stylesheet" type="text/css" href="css/meiro.css">
		
		<!--script src="libx/touch-emulator.js"></script>
		<script> TouchEmulator(); </script-->
		<script defer src="libx/three.min.js"></script>
		<script defer src="libx/Tween.js"></script>
		
		<script defer src="lib/main.js"></script>
		<script defer src="lib/languages.js"></script>
		<script defer src="lib/navigation.js"></script>
		<script defer src="lib/dungeon.js"></script>
		<script defer src="lib/dungeon.level.js"></script>
		<script defer src="lib/blueprint.js"></script>
		<script defer src="lib/primitives.js"></script>
		<script defer src="lib/font.js"></script>
		<script >
			var buttonBack;
			

			// adjust camera and projection when the screen size is changed
			// e.g. the smarthphone is rotated
			function onWindowResize()
			{
				renderer.setSize(window.innerWidth/MEIRO.RESOLUTION, window.innerHeight/MEIRO.RESOLUTION);
				
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.fov = 30;
				camera.updateProjectionMatrix();

				backgroundCamera.aspect = window.innerWidth / window.innerHeight;
				backgroundCamera.fov = 30;
				backgroundCamera.updateProjectionMatrix();

				reanimate();
			}


			function mainScene()
			{
				scene = new THREE.Scene();
				
				camera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 0.6, 1000);
				
				var bottomLight = new THREE.SpotLight( 'white', 0.5 );
					bottomLight.position.set( 1000, 3000, -500, 0.5 );
					
				var topLight = new THREE.SpotLight( 'white', 0.5 );
					topLight.position.set(-1000,-3000,500);
					
				scene.add( bottomLight, topLight );
			}
			
			
			function backgroundScene()
			{
				backgroundScene = new THREE.Scene();
				
				backgroundCamera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 1, 1000);
				backgroundCamera.position.set( 0, 0, 100 );
				
				var light = new THREE.DirectionalLight( 'white', 1 );
					light.position.set( 0, 0, 1 );
					light.penumbra = 1;
					
				var background = new THREE.Mesh(
						new THREE.SphereBufferGeometry( 100, 8, 5, 0, 2*Math.PI, 0, Math.PI/2 ),
						new THREE.MeshLambertMaterial({
							color: MEIRO.BACKGROUND_COLOR,
							side: THREE.BackSide,
							depthWrite: false,
						}));
					background.rotation.x = -Math.PI/2;
				
				backgroundScene.add( light, background );
			}
			
			
			function main()
			{
				// get Meiro options
				options = new MEIRO.Options();

				// initialize scene
				renderer = new THREE.WebGLRenderer({antialias: true});
				renderer.fullWindow();
				
				// set own resize handler
				window.removeEventListener('resize', onWindowResize);
				window.addEventListener('resize', onWindowResize);

				mainScene();
				
				backgroundScene();
				
				// managing the animation loop (to save battery and show statistics)
				animationLoop = new MEIRO.AnimationLoop(loop,true); 

				// create the dungeon
				dungeon = new MEIRO.Dungeon();
				blueprint =  new MEIRO.Blueprint();

				// setup mouse/touch/key navigation
				controls = new MEIRO.OrbitControls();
				controls.rotMin = 0.1;
				camera.target = new THREE.Vector3( options.size.x/2, 0, options.size.z/2 );

				// buttons for up/down/back/info
				buttonUp = new MEIRO.CornerButton('topLeft', goUp, 'GO UP', MEIRO.ICON.UP);
				buttonDown = new MEIRO.CornerButton('bottomLeft', goDown, 'GO DOWN', MEIRO.ICON.DOWN);
				if (options.backURL)
				{
					buttonBack = new MEIRO.CornerButton('topRight', goBack, 'CLOSE', MEIRO.ICON.BACK );
				}
				buttonHelp = new MEIRO.CornerButton('bottomRight', MEIRO.showInfo, 'INFO', MEIRO.ICON.INFO);

				// set initial button visibility
				buttonDown.showHide( blueprint.showLevel>0 );
				buttonUp.showHide( blueprint.showLevel+1 < dungeon.levels.length );
				
				MEIRO.PRIMITIVE = {
					FONT: new THREE.Font(MEIRO.FONT_JSON),
					STYLE: {LABEL: new THREE.MeshBasicMaterial({color:'crimson'})},
				};
				labelP = new MEIRO.Label('YOU ARE',0.5,0,1.5,0);
				labelP.position.set(options.player.x,1.5,options.player.z);
				scene.add( labelP );
				labelQ = new MEIRO.Label('HERE',0.5,0,0.8,0);
				labelQ.position.set(options.player.x,1.5,options.player.z);
				scene.add( labelQ );

			}
			
			// scene animation loop
			function loop()
			{
//labelP.rotateLabel();
		labelP.rotation.set(
			-controls.rot.y,
			Math.PI/2-controls.rot.x,
			0,
			'YXZ');
		labelQ.rotation.set(
			-controls.rot.y,
			Math.PI/2-controls.rot.x,
			0,
			'YXZ');
		
				TWEEN.update();
				controls.update();
				blueprint.update();
				animationLoop.update();

				renderer.autoClear = true;
				renderer.render( backgroundScene, backgroundCamera );
				renderer.autoClear = false;
				renderer.render( scene, camera );
			}

			// go up to the upper level
			function goUp()
			{
				buttonDown.showHide( blueprint.targetLevel>=0 );
				buttonUp.showHide( blueprint.targetLevel+2 < dungeon.levels.length );
				
				blueprint.goLevelUp();
			}

			// go down to the lower level
			function goDown()
			{
				buttonDown.showHide( blueprint.targetLevel>1 );
				buttonUp.show( blueprint.targetLevel < dungeon.levels.length );

				blueprint.goLevelDown();
			}

			// go back to given URL
			function goBack()
			{
				window.location.href = options.backURL + (options.backURL.indexOf('?')<0?'?':'&') + options.vitals();
			}

			
		</script> 
	</head>
	
	<body onload="main()">

		<div id="dimmer"></div>
		<div id="infoPanel" class="infoPanel">
			<h1>Карта</h1>
			<p>Това е схематична карта на целия лабиринт. Картата може да ползваш за ориентация и планиране на движението.</p>
			<p>С червен гео-маркер е отбелязано къде се намираш, а наличието на 3D модели е обозначено с квадрати.</p>
			<button onclick="MEIRO.hideInfo()">Close</button>
		</div>
	</body>
</html>