<!DOCTYPE html>

<html>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<head>
		<link rel="stylesheet" type="text/css" href="css/meiro.css">
		
		<!--script src="libx/touch-emulator.js"></script>
		<script> TouchEmulator(); </script-->
		<script src="libx/three.min.js"></script>
		<script src="libx/Tween.js"></script>
		
		<script src="lib/main.js"></script>
		<script src="lib/navigation.js"></script>
		<script src="lib/dungeon.js"></script>
		<script src="lib/dungeon.level.js"></script>
		<script src="lib/dungeon.blueprint.js"></script>
		<!--script src="lib/font.js"></script-->
		<script>
			var buttonBack;
			
			const ICON_UP = '<g fill="white"><path d="M 24 68 L 12 80 L 12 26 L 0 28 L 18 0 L 36 28 L 24 26 L 24 68 "/></g>';

			const ICON_DOWN = '<g fill="white"><path d="M 24 12 L 12 0 L 12 54 L 0 52 L 18 80 L 36 52 L 24 54 L 24 12 "/></g>';
			
			const ICON_INFO = '<g fill="white"><ellipse cx="8" cy="8" rx="8" ry="8" "/><path d="M 14 64 L 14 24 L 2 36 L 2 64 L 14 64 "/></g';
			
			const ICON_BACK = '<g fill="white"><path d="M 48 10 L 34 24 L 48 38 L 38 48 L 24 34 L 10 48 L 0 38 L 14 24 L 0 10 L 10 0 L 24 14 L 38 0 L 48 10 "/></g>';

			function onWindowResize() {
				renderer.setSize(window.innerWidth/MEIRO.RESOLUTION, window.innerHeight/MEIRO.RESOLUTION);
				//renderer.domElement.style = 'width:100%; height:100%; position:fixed; top:0; left:0; z-index:-1;';
				
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.fov = 30;
				camera.updateProjectionMatrix();

				reanimate();
			}

			function main()
			{
				// ------------------
				// INITIALIZATION
				// ------------------
				// initialize scene
				renderer = new THREE.WebGLRenderer({antialias: true});
				renderer.fullWindow();
				scene = new THREE.Scene();
				camera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 0.6, 400);

				window.removeEventListener('resize', onWindowResize);
				window.addEventListener('resize', onWindowResize);

				// add top and bottom lights
				var light = new THREE.DirectionalLight( 'white', 0.5 );
					light.position.set( 1000, 3000, -500, 0.5 );
					scene.add( light );
				light = light.clone();
					light.position.set(-1000,-3000,500);
					scene.add(light);
			
				options = new MEIRO.Options();

				// managing the animation loop (to save battery and show statistics)
				animationLoop = new MEIRO.AnimationLoop(loop,true); 

				// create the dungeon
				dungeon = new MEIRO.Dungeon();
				blueprint =  new MEIRO.Blueprint();

				// setup mouse/touch/key navigation
				controls = new MEIRO.OrbitControls();
				camera.target = new THREE.Vector3(options.size.x/2,0,options.size.z/2);

				// buttons for up/down
				buttonUp = new MEIRO.CornerButton('topLeft', goUp, 'GO UP', ICON_UP, 20);
				buttonDown = new MEIRO.CornerButton('bottomLeft', goDown, 'GO DOWN', ICON_DOWN, 20, 20);
				if (options.backURL)
				{
					buttonBack = new MEIRO.CornerButton('topRight', goBack, 'EXIT', ICON_BACK, 40, 10 );
				}
				
				// button for help info
				buttonHelp = new MEIRO.CornerButton('bottomRight', showInfo, 'INFO', ICON_INFO, 55, 30);

				// set initial button visibility
				buttonDown.showHide( blueprint.showLevel>0 );
				buttonUp.showHide( blueprint.showLevel+1 < dungeon.levels.length );
			}
			
			// scene animation loop
			function loop()
			{
				TWEEN.update();
				controls.update();
				blueprint.opacityLevels();
				animationLoop.update();
				
				renderer.render(scene, camera);
			}

			// go up to the upper level
			function goUp()
			{
				buttonDown.showHide( blueprint.showLevel>=0 );
				buttonUp.showHide( blueprint.showLevel+2 < dungeon.levels.length );

				blueprint.goLevelUp();
			}

			// go down to the lower level
			function goDown()
			{
				buttonDown.showHide( blueprint.showLevel>1 );
				buttonUp.show( blueprint.showLevel < dungeon.levels.length );

				blueprint.goLevelDown();
			}

			// go back to given URL
			function goBack()
			{
				window.location.href = options.backURL + (options.backURL.indexOf('?')<0?'?':'&') + options.vitals();
			}
			
			
			function showInfo()
			{
				window.addEventListener( 'keydown', hideInfo, false );
				document.body.style.backgroundColor = 'DimGray';
				
				var elems = document.getElementsByTagName('canvas');
				for (var i=0; i<elems.length; i++)
				{
					elems[i].className += ' blured';
					elems[i].style.pointerEvents = 'none';
				}
				
				var elems = document.getElementsByClassName('cornerButton');
				for (var i=0; i<elems.length; i++)
				{
					elems[i].className += ' blured';
					elems[i].style.pointerEvents = 'none';
				}
				
								
				document.getElementById('infoPanel').style.display = 'block';
			}
			
			function hideInfo()
			{
				window.removeEventListener( 'keydown', hideInfo );
				document.body.style.backgroundColor = 'DimGray';
				
				var elems = document.getElementsByTagName('canvas');
				for (var i=0; i<elems.length; i++)
				{
					elems[i].classList.remove('blured');
					elems[i].style.pointerEvents = 'auto';
				}
				
				var elems = document.getElementsByClassName('cornerButton');
				for (var i=0; i<elems.length; i++)
				{
					elems[i].classList.remove('blured');
					elems[i].style.pointerEvents = 'auto';
				}
				
				document.getElementById('infoPanel').style.display = 'none';
			}
			
		</script> 
	</head>
	
	<body onload="main()">
	
	
	
		<div id="infoPanel" class="infoPanel" onclick="hideInfo()">
			<h1>Карта</h1>
			<p>Това е схематична карта на целия лабиринт. Картата може да ползваш за ориентация и планиране на движението.</p>
			<p>С червен гео-маркер е отбелязано къде се намираш, а наличието на 3D модели е обозначено с квадрати.</p>
		</div>
	</body>
</html>