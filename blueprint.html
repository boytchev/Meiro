<!DOCTYPE html>

<html>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<head>
		<link rel="stylesheet" type="text/css" href="css/meiro.css">
		
		<!--script src="libx/touch-emulator.js"></script>
		<script> TouchEmulator(); </script-->
		<script src="libx/three.min.js"></script>
		<script src="libx/Tween.js"></script>
		
		<script src="lib/main.js"></script>
		<script src="lib/languages.js"></script>
		<script src="lib/navigation.js"></script>
		<script src="lib/dungeon.js"></script>
		<script src="lib/dungeon.level.js"></script>
		<script src="lib/blueprint.js"></script>
		<script src="lib/primitives.js"></script>
		<script src="lib/font.js"></script>
		<script>
			var buttonBack;
			

			function onWindowResize() {
				renderer.setSize(window.innerWidth/MEIRO.RESOLUTION, window.innerHeight/MEIRO.RESOLUTION);
				//renderer.domElement.style = 'width:100%; height:100%; position:fixed; top:0; left:0; z-index:-1;';
				
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.fov = 30;
				camera.updateProjectionMatrix();

				camera2.aspect = window.innerWidth / window.innerHeight;
				camera2.fov = 30;
				camera2.updateProjectionMatrix();

				reanimate();
			}

			function main()
			{
				// ------------------
				// INITIALIZATION
				// ------------------
				// initialize scene
				renderer = new THREE.WebGLRenderer({antialias: true});
				renderer.fullWindow();
				scene = new THREE.Scene();
				camera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 0.6, 1000);

				window.removeEventListener('resize', onWindowResize);
				window.addEventListener('resize', onWindowResize);

				// add top and bottom lights
				var light = new THREE.SpotLight( 'white', 0.5 );
					light.position.set( 1000, 3000, -500, 0.5 );
					scene.add( light );
				light = light.clone();
					light.position.set(-1000,-3000,500);
					scene.add(light);
			
				options = new MEIRO.Options();


				camera2 = camera.clone();
				camera2.position.set(0,0,100);
				scene2 = new THREE.Scene();
				var light2 = new THREE.DirectionalLight( 'white', 1 );
					light2.position.set( 0, 0, 1 );
					light2.penumbra = 1/2;
					scene2.add( light2 );
				var sphere2 = new THREE.Mesh(
					new THREE.SphereBufferGeometry( 100, 8, 8 ),
					new THREE.MeshLambertMaterial({
						color: MEIRO.BACKGROUND_COLOR,
						side: THREE.BackSide,
						depthWrite: false,
					})
				);
				sphere2.rotation.x = Math.PI/2;
				scene2.add( sphere2 );
				
				// managing the animation loop (to save battery and show statistics)
				animationLoop = new MEIRO.AnimationLoop(loop,true); 

				// create the dungeon
				dungeon = new MEIRO.Dungeon();
				blueprint =  new MEIRO.Blueprint();

				// setup mouse/touch/key navigation
				controls = new MEIRO.OrbitControls();
				controls.rotMin = 0.1;
				camera.target = new THREE.Vector3(options.size.x/2,0,options.size.z/2);

				// buttons for up/down
				buttonUp = new MEIRO.CornerButton('topLeft', goUp, 'GO UP', MEIRO.ICON.UP);
				buttonDown = new MEIRO.CornerButton('bottomLeft', goDown, 'GO DOWN', MEIRO.ICON.DOWN);
				if (options.backURL)
				{
					buttonBack = new MEIRO.CornerButton('topRight', goBack, 'CLOSE', MEIRO.ICON.BACK );
				}
				
				// button for help info
				buttonHelp = new MEIRO.CornerButton('bottomRight', MEIRO.showInfo, 'INFO', MEIRO.ICON.INFO);

				// set initial button visibility
				buttonDown.showHide( blueprint.showLevel>0 );
				buttonUp.showHide( blueprint.showLevel+1 < dungeon.levels.length );
				
				
				
				MEIRO.PRIMITIVE = {
					FONT: new THREE.Font(MEIRO.FONT_JSON),
					STYLE: {LABEL: new THREE.MeshBasicMaterial({color:'crimson'})},
				};
				labelP = new MEIRO.Label('YOU ARE',0.5,0,1.5,0);
				labelP.position.set(options.player.x,1.5,options.player.z);
				scene.add( labelP );
				labelQ = new MEIRO.Label('HERE',0.5,0,0.8,0);
				labelQ.position.set(options.player.x,1.5,options.player.z);
				scene.add( labelQ );

			}
			
			// scene animation loop
			function loop()
			{
//labelP.rotateLabel();
		labelP.rotation.set(
			-controls.rot.y,
			Math.PI/2-controls.rot.x,
			0,
			'YXZ');
		labelQ.rotation.set(
			-controls.rot.y,
			Math.PI/2-controls.rot.x,
			0,
			'YXZ');
		
				TWEEN.update();
				controls.update();
				blueprint.update();
				animationLoop.update();

				renderer.autoClear = true;
				renderer.render(scene2, camera2);
				renderer.autoClear = false;
				renderer.render(scene, camera);
			}

			// go up to the upper level
			function goUp()
			{
				buttonDown.showHide( blueprint.targetLevel>=0 );
				buttonUp.showHide( blueprint.targetLevel+2 < dungeon.levels.length );
				
				blueprint.goLevelUp();
			}

			// go down to the lower level
			function goDown()
			{
				buttonDown.showHide( blueprint.targetLevel>1 );
				buttonUp.show( blueprint.targetLevel < dungeon.levels.length );

				blueprint.goLevelDown();
			}

			// go back to given URL
			function goBack()
			{
				window.location.href = options.backURL + (options.backURL.indexOf('?')<0?'?':'&') + options.vitals();
			}

			
		</script> 
	</head>
	
	<body onload="main()">

		<div id="dimmer"></div>
		<div id="infoPanel" class="infoPanel">
			<h1>Карта</h1>
			<p>Това е схематична карта на целия лабиринт. Картата може да ползваш за ориентация и планиране на движението.</p>
			<p>С червен гео-маркер е отбелязано къде се намираш, а наличието на 3D модели е обозначено с квадрати.</p>
			<button onclick="MEIRO.hideInfo()">Close</button>
		</div>
	</body>
</html>